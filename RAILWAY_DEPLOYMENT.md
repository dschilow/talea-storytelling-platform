# üöÄ Talea Railway Deployment Guide

Complete step-by-step guide for deploying Talea Encore.ts application to Railway.

---

## üìã Prerequisites

### Required Accounts
- ‚úÖ [Railway Account](https://railway.app) (free tier works)
- ‚úÖ [Clerk Account](https://clerk.com) (free tier works)
- ‚úÖ GitHub account with repository

---

## üö¢ Deployment Steps

### 1. Deploy PostgreSQL

1. Go to Railway Dashboard ‚Üí Your Project
2. Click **"+ New"** ‚Üí **"Database"** ‚Üí **"PostgreSQL"**
3. Wait for deployment (~30 seconds)

Railway automatically provides these environment variables:
- `PGHOST`
- `PGPORT`
- `PGDATABASE`
- `PGUSER`
- `PGPASSWORD`

### 2. Deploy Backend

#### Step 2.1: Create Backend Service

1. Click **"+ New"** ‚Üí **"GitHub Repo"**
2. Select your repository
3. Name it: `backend` or `talea-backend`

#### Step 2.2: Configure Build Settings

Railway should auto-detect `railway.toml` and `Dockerfile.backend`.

**If not, manually set:**
- **Builder**: `DOCKERFILE`
- **Dockerfile Path**: `Dockerfile.backend`

#### Step 2.3: Add Environment Variables

In Railway Backend service ‚Üí **Variables**:

```bash
# Required
ClerkSecretKey=sk_test_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

# Automatically provided by Railway (don't add these manually)
PGHOST=postgres.railway.internal
PGPORT=5432
PGDATABASE=railway
PGUSER=postgres
PGPASSWORD=<auto-generated>
```

**Get Clerk Secret Key:**
1. Go to [Clerk Dashboard](https://dashboard.clerk.com)
2. Select your application
3. **API Keys** ‚Üí **Secret keys** ‚Üí Copy **Secret key**

#### Step 2.4: Deploy Backend

1. **Commit & Push** your code
2. Railway auto-deploys
3. Wait ~5-10 minutes for build
4. Check **"Deployments"** tab for status

#### Step 2.5: Get Backend URL

After deployment:
- Railway assigns public URL: `https://backend-production-XXXX.up.railway.app`
- **Copy this URL** - needed for frontend

#### Step 2.6: Verify Backend Health

Open in browser:
```
https://backend-production-XXXX.up.railway.app/health
```

**Expected Response:**
```json
{
  "status": "healthy",
  "message": "Talea Encore Backend is running",
  "timestamp": "2025-10-13T..."
}
```

---

### 3. Deploy Frontend

#### Step 3.1: Create Frontend Service

1. Click **"+ New"** ‚Üí **"GitHub Repo"**
2. Select your repository (again)
3. Name it: `frontend` or `talea-frontend`

#### Step 3.2: Configure Build Settings

**Manually set:**
- **Builder**: `DOCKERFILE`
- **Dockerfile Path**: `Dockerfile.frontend`

#### Step 3.3: Add Environment Variables

In Railway Frontend service ‚Üí **Variables**:

```bash
# Required
VITE_BACKEND_URL=https://backend-production-XXXX.up.railway.app
VITE_CLERK_PUBLISHABLE_KEY=pk_test_XXXXXXXXXXXXXXXXXXXXXXXX

# Replace XXXX with your actual backend URL
```

**Get Clerk Publishable Key:**
1. Go to [Clerk Dashboard](https://dashboard.clerk.com)
2. Select your application
3. **API Keys** ‚Üí **Quick Copy** ‚Üí **Next.js** ‚Üí Copy the publishable key

#### Step 3.4: Deploy Frontend

1. **Redeploy** if already running (to pick up env vars)
2. Wait ~3-5 minutes
3. Check **"Deployments"** tab

#### Step 3.5: Get Frontend URL

After deployment:
- Railway assigns public URL: `https://frontend-production-XXXX.up.railway.app`
- **Copy this URL**

---

### 4. Update CORS Configuration

#### Step 4.1: Update Backend CORS

Update `backend/encore.app` with your frontend URL:

```json
{
  "id": "talea-storytelling-platform-4ot2",
  "lang": "typescript",
  "global_cors": {
    "allow_origins_with_credentials": [
      "http://localhost:5173",
      "http://localhost:5174",
      "https://frontend-production-XXXX.up.railway.app"
    ],
    "debug": true
  }
}
```

**Commit and push** - Backend will auto-redeploy.

#### Step 4.2: Update Clerk Allowed Origins

1. Go to [Clerk Dashboard](https://dashboard.clerk.com)
2. Select your application
3. **Settings** ‚Üí **Domains**
4. Add your frontend URL: `https://frontend-production-XXXX.up.railway.app`

---

### 5. Initialize Database

Encore automatically runs migrations on startup. The databases are created from:
- `backend/user/migrations/`
- `backend/avatar/migrations/`
- `backend/story/migrations/`
- `backend/doku/migrations/`
- `backend/ai/migrations/`

Verify in Railway PostgreSQL service:
1. Go to **"Connect"** ‚Üí **"psql"**
2. Run: `\dt`

**Should see tables like:**
```
public | users
public | avatars
public | avatar_memories
public | avatar_doku_read
public | avatar_story_read
public | stories
public | dokus
public | personality_updates
```

---

### 6. Verify Deployment

#### Test Backend Health
```
https://backend-production-XXXX.up.railway.app/health
```

#### Test Frontend
```
https://frontend-production-XXXX.up.railway.app
```

**Should see:**
- Clerk sign-in page
- Sign in with your Clerk account
- Dashboard with Avatars, Stories, and Dokus

#### Test Full Flow

1. **Sign in** with Clerk
2. **Create an avatar**
3. **Generate a story** with the avatar
4. **Verify personality traits** update after reading

---

## üîß Important Configuration Files

### Created Files for Railway:
- ‚úÖ `Dockerfile.backend` - Backend Docker configuration
- ‚úÖ `Dockerfile.frontend` - Frontend Docker configuration
- ‚úÖ `railway.toml` - Railway deployment configuration
- ‚úÖ `backend/infra.config.railway.json` - Encore infrastructure config
- ‚úÖ `backend/start.sh` - Backend startup script
- ‚úÖ `nginx.conf` - Frontend nginx configuration
- ‚úÖ `docker-entrypoint.sh` - Frontend entrypoint script
- ‚úÖ `backend/health/health.ts` - Health check endpoint

### Updated Files:
- ‚úÖ `backend/encore.app` - Added CORS configuration

---

## üõ†Ô∏è Common Issues

### Issue: Backend Build Fails

**Check:**
- Railway is using `Dockerfile.backend` (not Nixpacks)
- All environment variables are set correctly
- Check build logs for specific errors

### Issue: CORS Errors

**Solution:**
1. Verify frontend URL in `backend/encore.app`
2. Verify Clerk domain configuration
3. Ensure using `allow_origins_with_credentials` (not `allow_origins_without_credentials`)

### Issue: Database Tables Don't Exist

**Solution:**
- Check backend logs for migration errors
- Encore runs migrations automatically on startup
- Verify `PGPASSWORD` environment variable exists

### Issue: 401 Unauthorized

**Solution:**
1. Verify `ClerkSecretKey` is correct in Railway backend variables
2. Should start with `sk_test_` (development) or `sk_live_` (production)
3. Verify Clerk publishable key in frontend variables

---

## üìä Services Overview

Your Railway project should have **3 services**:

1. **PostgreSQL Database**
   - Automatically managed by Railway
   - Provides connection variables

2. **Backend (Encore.ts)**
   - Port: 8080
   - Health check: `/health`
   - Built with: `Dockerfile.backend`

3. **Frontend (React + Vite)**
   - Port: 80
   - Built with: `Dockerfile.frontend`
   - Served with: nginx

---

## üéâ Deployment Complete!

Your Talea application is now running on Railway with:
- ‚úÖ Backend API (Encore.ts)
- ‚úÖ Frontend (React + Clerk)
- ‚úÖ PostgreSQL Database
- ‚úÖ Type-safe APIs
- ‚úÖ Authentication (Clerk)
- ‚úÖ Avatar Personality System
- ‚úÖ Story Generation
- ‚úÖ AI Integration

---

## üìù Next Steps

1. **Monitor Logs:** Railway ‚Üí Each service ‚Üí "Logs" tab
2. **Set up Custom Domains:** Railway ‚Üí Service ‚Üí Settings ‚Üí Domains
3. **Production Clerk Keys:** Replace dev keys with production keys
4. **Scale Services:** Railway ‚Üí Service ‚Üí Settings ‚Üí Resources

---

**Need Help?** Check Railway logs for detailed error messages and verify all environment variables are correct.
